<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta content="manixaist.github.io" property="og:site_name">

  <meta content="Cross Platform Game - 05" property="og:title">


  <meta content="article" property="og:type">


  <meta content="<h1>Developer Journal</h1><h4>Github pages for coding projects:</h4><p/><h4>A collection of my hobbyist projects.</h4><p/><a href='http://xkcd.com/1724/'><img src='http://imgs.xkcd.com/comics/proofs.png'/></a" property="og:description">


  <meta content="http://manixaist.github.io/coding/game/xplat/2016/09/20/xplat-pmc-05.html" property="og:url">


  <meta content="2016-09-20T10:47:00-07:00" property="article:published_time">
  <meta content="http://manixaist.github.io/about/" property="article:author">


  <meta property="og:image" content="">


  
  <meta content="coding" property="article:section">
  


  

  <title>Cross Platform Game - 05</title>
  <meta name="description" content="Enemy Ghosts and AIToday we add ghosts. Well 1 ghost, but we’re adding the code to get 95% of the way there for the remaining ghosts in the future.Our ghost ...">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/css/main.css">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

  <link href='https://fonts.googleapis.com/css?family=PT+Sans' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Mono' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,200,300,500,600,700,900' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Alegreya:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Lora:400,400italic,700' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Fira+Sans:400,300,500,700' rel='stylesheet' type='text/css'>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-hQpvDQiCJaD2H465dQfA717v7lu5qHWtDbWNPvaTJ0ID5xnPUlVXnKzq7b8YUkbN" crossorigin="anonymous">
  <link rel="canonical" href="http://manixaist.github.io/coding/game/xplat/2016/09/20/xplat-pmc-05.html">
  <link rel="alternate" type="application/rss+xml" title="manixaist.github.io" href="http://manixaist.github.io/feed.xml">
</head>


  <body>
<section>
<nav class="navbar navbar-default navbar-fixed-top">

  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">manixaist.github.io</a>
    </div>


    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav">
        
        

        
        

        
        

        


      </ul>

    <!--  <ul class="nav navbar-nav navbar-right">
        <li><a href="#">Know More!</a></li>

      </ul>-->
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>
</section>

<section>
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <div class="jumbotron">
    <div class="container">
      <h1 class="post-title-main" itemprop="name headline">Cross Platform Game - 05</h1>
      <p class="post-meta"><time datetime="2016-09-20T10:47:00-07:00" itemprop="datePublished">Sep 20, 2016</time> • <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">manixaist</span></span></p>
      
    </div>

</div>


  <div class="post-content container" itemprop="articleBody">
    <h1 id="enemy-ghosts-and-ai">Enemy Ghosts and AI</h1>
<p>Today we add ghosts. Well 1 ghost, but we’re adding the code to get 95% of the way there for the remaining ghosts in the future.
Our ghost today is Blinky - and he chases Pac-Man (clone) most directly.</p>

<p><img src="/images/blinky.png" alt="Blinky" /></p>

<p>Behold our end goal for today!</p>

<p><img src="/images/PMC05.gif" alt="Running Win32 Application" /></p>

<hr />

<h2 id="goals-for-today">Goals for Today</h2>
<ul>
  <li>Describe ghost AI behavior</li>
  <li>Division of labor by class</li>
  <li>Branching decisions for AI (specific ghost behavior)</li>
  <li>Ghost Warping/Pen and States Revisited</li>
</ul>

<h3 id="assumptions">Assumptions</h3>
<ul>
  <li>You went through the previous post(s)</li>
</ul>

<hr />

<h4 id="github-repohttpsgithubcommanixaistxplat-pmc-tutorial-05"><a href="https://github.com/manixaist/xplat-pmc-tutorial-05">Github repo</a></h4>

<h2 id="ghost-ai-behavior">Ghost AI Behavior</h2>
<p>Once again <a href="http://hackipedia.org/Games/Arcade/Pac-man/pacman,%20dossier.html">there are sources</a> for all this Pac-Man info..</p>

<p>Summarized: when ghosts enter a new cell, they look ahead one tile from their current location and decide what to do once they eventually reach it.
When they do (always once they get to the center) that previous decision is applied and a change in direction is applied if needed.  This means
the ghosts are constantly swapping out these 2 “decisions” as they move through the maze.</p>

<h3 id="so-how-is-that-decision-made">So How Is That Decision Made?</h3>
<p>This depends on the tile and potentially the specific ghost.  If the tile in question has only 1 valid exit, the ghost will choose it.  Ghosts cannot
change direction on their own (e.g. reverse) and there are no dead-ends in the maze, so this should be the case anywhere on the maze.</p>

<p>Now if that cell has more than one option (not counting the direction it came) then we need to choose which to pick, and this is based on the ghost
in question.  For Blinky, he alwyas takes the most direct route (shortest distance) to the player.</p>

<h3 id="detailed-example">Detailed example</h3>
<p>Here we have a ghost in a starting cell with a direction indicated by the arrow.</p>

<p><img src="/images/Ghost01.png" alt="G1" /></p>

<p>And now the ghost has moved into a new cell; it’s at this point it looks ahead and makes a decision.  In this case it’s an intersection, so the choice would be deferred to the specific ghost type, but let us say LEFT is chosen (shown by the small green arrow).</p>

<p><img src="/images/Ghost02.png" alt="G1" /></p>

<p>Now the ghost really has no choice.  Remember it cannot reverse, and thus the only valid cell to exit from is straight ahead.  There is no reason at all to bother the specific ghost logic here.</p>

<p><img src="/images/Ghost03.png" alt="G1" /></p>

<p>Moving ahead…here is a similar situation, except the only valid choice still requires a change in direction.  It’s important to make decisions based on the intended direction for that cell, rather than the ghosts current direction in these cases.</p>

<p><img src="/images/Ghost04.png" alt="G1" /></p>

<p>And lastly we see that decision applied once the ghost reaches the center.</p>

<p><img src="/images/Ghost05.png" alt="G1" /></p>

<h2 id="division-of-labor">Division of Labor</h2>
<p>We can see that a non-insignificant amount of code is common to both ghosts and the player (they are both sprites after all) and that there exists quite a bit of common logic for ghosts, but they are distinguished by</p>

<ul>
  <li>Intersection Decision logic</li>
  <li>Graphics</li>
  <li>Speed</li>
  <li>Penned or not at start?</li>
  <li>When it gets unpenned</li>
</ul>

<p>Or if we were to arrange this by class hierarchy, we might see something like this…</p>

<p><img src="/images/ClassHier.png" alt="CH" /></p>

<h2 id="branching-decisions-for-ai-specific-ghost-behavior">Branching Decisions for AI (specific ghost behavior)</h2>
<p>Here is an abbreviated excerpt of the Ghost class</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp">    <span class="c1">// Our Ghost class will encapsulate the basic behavior common to every ghost
</span>    <span class="c1">// (e.g. movement when not at an intersection) but will defer branching logic
</span>    <span class="c1">// (e.g. the case above - intersections) and texture specific loading and values
</span>    <span class="c1">// like base speed to a derived class.
</span>    <span class="c1">// I.e. this class does not exist by itself, somewhere there is a Blinky : Ghost,
</span>    <span class="c1">// Clyde : Ghost, etc
</span>    <span class="k">class</span> <span class="nc">Ghost</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Sprite</span>
    <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
        <span class="n">Ghost</span><span class="p">(</span><span class="n">TextureWrapper</span> <span class="o">*</span><span class="n">pTextureWrapper</span><span class="p">,</span> 
		<span class="n">Uint16</span> <span class="n">cxFrame</span><span class="p">,</span> <span class="n">Uint16</span> <span class="n">cyFrame</span><span class="p">,</span> 
		<span class="n">Uint16</span> <span class="n">cFramesTotal</span><span class="p">,</span> <span class="n">Uint16</span> <span class="n">cAnimationsTotal</span><span class="p">);</span>
        
        <span class="k">virtual</span> <span class="o">~</span><span class="n">Ghost</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="n">SafeDelete</span><span class="o">&lt;</span><span class="n">Decision</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pCurrentDecision</span><span class="p">);</span>
            <span class="n">SafeDelete</span><span class="o">&lt;</span><span class="n">Decision</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_pNextDecision</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// "Interface" for Ghosts to implement
</span>        <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">Initialize</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">Reset</span><span class="p">(</span><span class="n">Maze</span> <span class="o">*</span><span class="n">pMaze</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">virtual</span> <span class="n">Direction</span> <span class="n">MakeBranchDecision</span><span class="p">(</span>
		<span class="n">Uint16</span> <span class="n">nRow</span><span class="p">,</span> <span class="n">Uint16</span> <span class="n">nCol</span><span class="p">,</span>					
		<span class="n">Player</span><span class="o">*</span> <span class="n">pPlayer</span><span class="p">,</span> <span class="n">Maze</span> <span class="o">*</span><span class="n">pMaze</span><span class="p">)</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="c1">// General movement that is common to all ghosts
</span>        <span class="kt">void</span> <span class="n">Update</span><span class="p">(</span><span class="n">Player</span><span class="o">*</span> <span class="n">pPlayer</span><span class="p">,</span> <span class="n">Maze</span><span class="o">*</span> <span class="n">pMaze</span><span class="p">);</span>

    <span class="k">protected</span><span class="o">:</span></code></pre></figure>

<p>The pure virtual methods are there to be implemented by the specific ghost type.  They handle the graphics and member setup, as well as that all important branching decision.  E.g.</p>

<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp">    <span class="c1">// "Blinky" type ghost.  This class is a thin wrapper in most places, 
</span>    <span class="c1">// just holding the specific tile initialization code for example
</span>    <span class="c1">// This class also defines the specific movement behavior
</span>    <span class="c1">// e.g. what are its target tiles at intersections
</span>    <span class="k">class</span> <span class="nc">Blinky</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Ghost</span>
    <span class="p">{</span>
    <span class="k">public</span><span class="o">:</span>
        <span class="n">Blinky</span><span class="p">(</span><span class="n">TextureWrapper</span><span class="o">*</span> <span class="n">pTextureWrapper</span><span class="p">);</span>

        <span class="c1">// "Interface" implemented here
</span>        <span class="kt">bool</span> <span class="n">Initialize</span><span class="p">();</span>
        <span class="kt">bool</span> <span class="n">Reset</span><span class="p">(</span><span class="n">Maze</span> <span class="o">*</span><span class="n">pMaze</span><span class="p">);</span>
        <span class="n">Direction</span> <span class="n">MakeBranchDecision</span><span class="p">(</span>
		<span class="n">Uint16</span> <span class="n">nRow</span><span class="p">,</span> <span class="n">Uint16</span> <span class="n">nCol</span><span class="p">,</span> 
		<span class="n">Player</span><span class="o">*</span> <span class="n">pPlayer</span><span class="p">,</span> <span class="n">Maze</span> <span class="o">*</span><span class="n">pMaze</span><span class="p">);</span>
    <span class="p">};</span></code></pre></figure>

<p>Now <a href="https://github.com/manixaist/xplat-pmc-tutorial-05/blob/master/blinky.cpp">Blinky</a> cares about the shortest route, so check the implementation to see how I did that.  Remember we’re attempting to code for clarity here.</p>

<h2 id="ghost-warping-and-states-revisited">Ghost Warping and States Revisited</h2>
<p>Last time, we introduced the concept of a GameState and rewrote our loop slightly to allow the state to dictate the code path.  Today, we’re going to extend that to the Sprite subclasses and fix the main loop to care only about updating the various objects in the frame.  In other words, we’re also moving the Player warping state to the Player code and out of the GameHarness.</p>

<p>This way each object can be in charge of managing its substate (e.g. warping, scattering, dying, etc).</p>

<p>The Ghosts and the Player will handle warping very similarly.  I encourage you to look at the code for each</p>

<p><a href="https://github.com/manixaist/xplat-pmc-tutorial-05/blob/master/player.cpp">Player</a></p>

<p><a href="https://github.com/manixaist/xplat-pmc-tutorial-05/blob/master/ghost.cpp">Ghost</a></p>

<p>The gist of it is the same as last time, only applied to both classes.  The Ghosts get a penalty to speed in the warp, but otherwise behave the same.</p>

<h2 id="ghost-pen">Ghost Pen</h2>
<p>If you take a look at the collision map, you’ll see I hollowed out the little area in the center for the ghost pen.  If I place a ghost in there, it cannot get out on its own.  Pen problem solved.</p>

<p>Of course at some point you’ll want to let the ghost out, so we start a timer, and once it’s finished, we transition to a state much like warping, moving the ghost one cell out into the maze.  At this point, we turn it loose in normal chase mode.</p>

<p>In the original Pac-Man, Blinky would start outside of the pen and the others would be released later.  For this post’s version, Blinky will start inside the pen, so we can see that logic working.</p>

<h2 id="output">Output</h2>
<hr />
<p>win32 (linux looks the same, compile it and see! I checked)</p>

<p><img src="/images/PMC05.gif" alt="Running Win32 Application" /></p>

<hr />

<h3 id="coming-soon">Coming soon</h3>
<p>The remaining ghosts, tweaking their AI, and Player lives.</p>


  </div>

</article>

</section>
<nav class="navbar navbar-default navbar-fixed-bottom">
  <div class="container footer-content">
    <p>2016-09-20 10:47:00 -0700</p>
  </div>
</nav>


  </body>

</html>
